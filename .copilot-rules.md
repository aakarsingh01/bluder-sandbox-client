# CodeSandbox Offline Workspace Rules & Guidelines

## Project Overview
This workspace contains a **fully offline CodeSandbox deployment** with complete Docker containerization. The setup blocks all external CodeSandbox API calls while maintaining core functionality and providing user-friendly error messages.

## Core Principles & Rules

### ğŸš« API Blocking Strategy
- **Three-Layer Approach**: JavaScript patches, Service Worker interception, and Nginx-level blocking
- **User-Friendly Responses**: Always return HTTP 200 with helpful messages instead of failures
- **Message Format**: "Cannot render the page" + suggestion to "download and run locally"
- **Blocked Domains**: `*.codesandbox.io`, `*.csb.app`, `*.csb.dev`, AWS CodeSandbox APIs, analytics
- **Allowed Domains**: NPM registry, CDN services (unpkg, skypack, esm.sh)

### ğŸ³ Docker Configuration Rules
- **Base Image**: `nginx:alpine` for lightweight deployment
- **Port Mapping**: Host 8080 â†’ Container 80
- **Health Checks**: Every 30s with `/` endpoint validation
- **Entrypoint Script**: Must provide startup status and configuration info
- **Build Process**: Apply patches during container build, not runtime

### ğŸ”“ CORS Policy (Latest Rule)
- **Completely Permissive**: Allow everything, no restrictions
- **Headers Required**: 
  - `Access-Control-Allow-Origin: *`
  - `Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD`
  - `Access-Control-Allow-Headers: *`
  - `Access-Control-Allow-Credentials: true`
- **Apply Everywhere**: Nginx responses, Service Worker responses, JavaScript patches
- **OPTIONS Handling**: Return 204 with full CORS headers for preflight requests

### ğŸ“ File Structure Rules
```
/
â”œâ”€â”€ docker-compose.yml          # Primary deployment method
â”œâ”€â”€ Dockerfile                  # Alpine + nginx + bash
â”œâ”€â”€ nginx-offline.conf          # CORS-permissive config with API blocking
â”œâ”€â”€ patches/                    # Offline modification scripts
â”‚   â”œâ”€â”€ offline-patch.js        # JavaScript API + CORS patches
â”‚   â””â”€â”€ offline-sw.js          # Service worker with CORS headers
â”œâ”€â”€ apply-offline-patches.sh    # Build-time patch application
â”œâ”€â”€ docker-entrypoint.sh        # Container startup with status info
â”œâ”€â”€ offline.html               # Offline mode landing page
â”œâ”€â”€ blocked-api.html           # API blocked error page
â””â”€â”€ [CodeSandbox files]        # Original build files
```

### ğŸ”§ Environment Variables
- `IS_ONPREM=true` - On-premises deployment flag
- `OFFLINE_MODE=true` - Enables offline-specific features
- `USE_STATIC_PREVIEW=true` - Static preview mode

### ğŸ“Š Monitoring & Health
- **Endpoints**:
  - `/` - Main application
  - `/health` - Health check (returns main app)
  - `/offline-config.json` - Configuration info
- **Status Logging**: Container startup must show detailed configuration
- **Error Handling**: Graceful degradation with helpful messages

### ğŸ›¡ï¸ Security & Performance
- **No External Data**: Zero data leaves local network except NPM registry
- **Analytics Disabled**: All telemetry and tracking blocked
- **Caching Strategy**: 1-year cache for static assets, no-cache for patches/workers
- **Compression**: Gzip enabled for text-based files

### ğŸš€ Deployment Rules
- **Command**: `docker-compose up` (must be plug-and-play)
- **Build Time**: Target ~3-5 seconds cold start
- **Memory Usage**: Keep under 100MB
- **No Manual Steps**: Everything automated in container build

### ğŸ”„ Development Workflow
1. **Edit patches** in `patches/` directory
2. **Run** `./apply-offline-patches.sh` to apply changes
3. **Test** with `docker-compose up --build`
4. **Verify** CORS headers and API blocking
5. **Commit** all changes to git

### âš ï¸ Critical Requirements
- **Always HTTP 200**: Never return error codes for blocked APIs
- **CORS Everywhere**: Every response must include permissive CORS headers
- **Helpful Messages**: Provide clear instructions for local development
- **NPM Access**: Must allow package installation from registry
- **Docker Native**: No external dependencies beyond Docker

### ğŸ¯ Success Criteria
- âœ… Starts with single command: `docker-compose up`
- âœ… No external CodeSandbox API calls
- âœ… All CORS requests succeed
- âœ… User-friendly error messages for blocked features
- âœ… NPM package installation works
- âœ… Health monitoring functional
- âœ… Can be embedded from any domain

## Quick Commands
```bash
# Deploy
docker-compose up

# Rebuild after changes
docker-compose up --build

# Test CORS headers
curl -I http://localhost:8080/

# Test API blocking
curl http://localhost:8080/api/v1/sandboxes

# Check logs
docker logs codesandbox-offline

# Clean up
docker-compose down
```

## Repository: `aakarsingh01/bluder-sandbox-client`
- **Branch**: `main`
- **Latest**: Full CORS permissive configuration
- **Status**: Production-ready offline CodeSandbox deployment