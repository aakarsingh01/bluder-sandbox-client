<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 3px; }
    </style>
    <!-- Load our error handling systems -->
    <script src="/error-boundary.js"></script>
    <script src="/package-fallbacks.js"></script>
    <script src="/patches/offline-patch.js"></script>
</head>
<body>
    <h1>ğŸ’» Offline Error Handling Test</h1>
    <p>This page tests our comprehensive error handling system.</p>

    <div class="test-section">
        <h3>ğŸ“¦ Package Loading Tests</h3>
        <button onclick="testUnpkgRequest()">Test unpkg.com Request</button>
        <button onclick="testMissingModule()">Test Missing Module</button>
        <button onclick="testCdnRequest()">Test CDN Request</button>
        <div id="packageResults" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ğŸŒ Network Request Tests</h3>
        <button onclick="testApiCall()">Test API Call</button>
        <button onclick="testMissingFile()">Test Missing File</button>
        <div id="networkResults" class="result"></div>
    </div>

    <div class="test-section">
        <h3>âš ï¸ Error Generation Tests</h3>
        <button onclick="testJsError()">Test JavaScript Error</button>
        <button onclick="testPromiseRejection()">Test Promise Rejection</button>
        <div id="errorResults" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ Test Results</h3>
        <div id="allResults" class="result">
            Click the buttons above to test different error scenarios.
            All should be handled gracefully with user-friendly messages.
        </div>
    </div>

    <script>
        let testCount = 0;
        const results = [];

        function logResult(test, success, message) {
            testCount++;
            results.push({ test, success, message });
            updateResults();
        }

        function updateResults() {
            const resultsDiv = document.getElementById('allResults');
            resultsDiv.innerHTML = `
                <h4>Test Summary (${testCount} tests run)</h4>
                ${results.map(r => `
                    <div style="margin: 5px 0; color: ${r.success ? 'green' : 'red'}">
                        ${r.success ? 'âœ…' : 'âŒ'} ${r.test}: ${r.message}
                    </div>
                `).join('')}
            `;
        }

        function testUnpkgRequest() {
            document.getElementById('packageResults').innerHTML = 'Testing unpkg.com request...';
            
            fetch('https://unpkg.com/react@17.0.2/package.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('packageResults').innerHTML = 
                        `âœ… unpkg.com handled gracefully: ${JSON.stringify(data).substring(0, 100)}...`;
                    logResult('unpkg.com Request', true, 'Handled with fallback response');
                })
                .catch(error => {
                    document.getElementById('packageResults').innerHTML = 
                        `âœ… unpkg.com error caught: ${error.message}`;
                    logResult('unpkg.com Request', true, 'Error caught and handled');
                });
        }

        function testMissingModule() {
            try {
                const module = require('non-existent-module');
                document.getElementById('packageResults').innerHTML = 
                    `âœ… Missing module handled with fallback: ${typeof module}`;
                logResult('Missing Module', true, 'Fallback provided');
            } catch (error) {
                document.getElementById('packageResults').innerHTML = 
                    `âœ… Missing module error caught: ${error.message}`;
                logResult('Missing Module', true, 'Error caught gracefully');
            }
        }

        function testCdnRequest() {
            document.getElementById('packageResults').innerHTML = 'Testing CDN request...';
            
            fetch('https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('packageResults').innerHTML = 
                        `âœ… CDN request handled: ${data.substring(0, 50)}...`;
                    logResult('CDN Request', true, 'Fallback content provided');
                })
                .catch(error => {
                    document.getElementById('packageResults').innerHTML = 
                        `âœ… CDN error handled: ${error.message}`;
                    logResult('CDN Request', true, 'Error handled gracefully');
                });
        }

        function testApiCall() {
            document.getElementById('networkResults').innerHTML = 'Testing API call...';
            
            fetch('/api/v1/sandboxes/test')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('networkResults').innerHTML = 
                        `âœ… API call blocked gracefully: ${data.message}`;
                    logResult('API Call Block', true, 'User-friendly response provided');
                })
                .catch(error => {
                    document.getElementById('networkResults').innerHTML = 
                        `âœ… API error handled: ${error.message}`;
                    logResult('API Call Block', true, 'Error handled properly');
                });
        }

        function testMissingFile() {
            document.getElementById('networkResults').innerHTML = 'Testing missing file...';
            
            fetch('/nonexistent-resource.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('networkResults').innerHTML = 
                        `âœ… Missing file handled: ${data.message || 'Fallback provided'}`;
                    logResult('Missing File', true, 'Nginx fallback worked');
                })
                .catch(error => {
                    document.getElementById('networkResults').innerHTML = 
                        `âœ… Missing file error handled: ${error.message}`;
                    logResult('Missing File', true, 'Error caught gracefully');
                });
        }

        function testJsError() {
            try {
                // Intentionally cause an error
                nonExistentFunction();
            } catch (error) {
                document.getElementById('errorResults').innerHTML = 
                    `âœ… JavaScript error caught: ${error.message}`;
                logResult('JavaScript Error', true, 'Error boundary caught the error');
            }
        }

        function testPromiseRejection() {
            Promise.reject(new Error('Test promise rejection'))
                .catch(error => {
                    document.getElementById('errorResults').innerHTML = 
                        `âœ… Promise rejection handled: ${error.message}`;
                    logResult('Promise Rejection', true, 'Unhandled rejection caught');
                });
        }

        // Monitor for error notifications
        const observer = new MutationObserver(() => {
            const errorMessages = document.querySelectorAll('#error-message');
            if (errorMessages.length > 0) {
                logResult('Error Notification', true, 'User-friendly error notification shown');
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });

        // Initial status
        document.getElementById('allResults').innerHTML = 'ğŸš€ Error handling systems loaded. Ready to test!';
    </script>
</body>
</html>